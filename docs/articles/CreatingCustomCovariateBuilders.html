<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creating custom covariate builders • FeatureExtraction</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Creating custom covariate builders">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FeatureExtraction</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.2.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CreatingCovariatesUsingCohortAttributes.html">Creating covariates using cohort attributes</a>
    </li>
    <li>
      <a href="../articles/CreatingCustomCovariateBuilders.html">Creating custom covariate builders</a>
    </li>
    <li>
      <a href="../articles/CreatingCustomCovariateBuildersKorean.html">Creating custom covariate builders (Korean)</a>
    </li>
    <li>
      <a href="../articles/UsingFeatureExtraction.html">Using FeatureExtraction</a>
    </li>
    <li>
      <a href="../articles/UsingFeatureExtractionKorean.html">Using FeatureExtraction (Korean)</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/OHDSI/FeatureExtraction">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Creating custom covariate builders</h1>
                        <h4 class="author">Martijn J. Schuemie</h4>
            
            <h4 class="date">2019-08-28</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/FeatureExtraction/blob/master/vignettes/CreatingCustomCovariateBuilders.Rmd"><code>vignettes/CreatingCustomCovariateBuilders.Rmd</code></a></small>
      <div class="hidden name"><code>CreatingCustomCovariateBuilders.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette assumes you are already familiar with the <code>FeatureExtraction</code> package.</p>
<p>The <code>FeatureExtraction</code> package can generate a default set of covariates, such as one covariate for each condition found in the <code>condition_occurrence</code> table. However, for some reasons one might need other covariates than those included in the default set. Sometimes it might make sense to request the new covariates be added to the standard list, but other times there is good reason to keep them separated.</p>
<p>The <code>FeatureExtraction</code> package has a mechanism for including custom covariate builders to either replace or complement the covariate builders included in the package. This vignette describes that mechanism.</p>
<p>Note: another way to add custom covariates is by using the <code>cohort_attribute</code> table in the common data model. This approach is described in the vignette called <code>creating covariates using cohort attributes</code>, and might be more suitable if you are likely to need the covariates only once, or when you are less familiar with advanced R programming. Creating a custom covariate builder as described in this vignette is more complicated, but once completed can easily be reused in many studies.</p>
</div>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>To add a custom covariate builder, two things need to be implemented:</p>
<ol style="list-style-type: decimal">
<li>A function that creates a <code>covariateSettings</code> object for the custom covariates.</li>
<li>A function that uses the covariate settings to construct the new covariates.</li>
</ol>
</div>
<div id="covariate-settings-function" class="section level1">
<h1 class="hasAnchor">
<a href="#covariate-settings-function" class="anchor"></a>Covariate settings function</h1>
<p>The covariate settings function must create an object that meets two requirements:</p>
<ol style="list-style-type: decimal">
<li>The object must be of class <code>covariateSettings</code>.</li>
<li>The object must have an attribute <code>fun</code> that specifies the name of the function for generating the covariates.</li>
</ol>
<div id="example-function" class="section level2">
<h2 class="hasAnchor">
<a href="#example-function" class="anchor"></a>Example function</h2>
<p>Here is an example covariate settings function:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>createLooCovariateSettings &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">useLengthOfObs =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb1-2"><a href="#cb1-2"></a>  covariateSettings &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">useLengthOfObs =</span> useLengthOfObs)</span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="kw"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(covariateSettings, <span class="st">"fun"</span>) &lt;-<span class="st"> "getDbLooCovariateData"</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(covariateSettings) &lt;-<span class="st"> "covariateSettings"</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(covariateSettings)</span>
<span id="cb1-6"><a href="#cb1-6"></a>}</span></code></pre></div>
<p>In this example the function has only one argument: <code>useLengthOfObs</code>. This argument is stored in the <code>covariateSettings</code> object. We specify that the name of the function that will construct the covariates corresponding to these options is <code>getDbLooCovariateData</code>.</p>
</div>
</div>
<div id="covariate-construction-function" class="section level1">
<h1 class="hasAnchor">
<a href="#covariate-construction-function" class="anchor"></a>Covariate construction function</h1>
<div id="function-inputs" class="section level2">
<h2 class="hasAnchor">
<a href="#function-inputs" class="anchor"></a>Function inputs</h2>
<p>The covariate construction function has to accept the following arguments:</p>
<ul>
<li>
<code>connection</code>: A connection to the server containing the schema as created using the <code>connect</code> function in the <code>DatabaseConnector</code> package.</li>
<li>
<code>oracleTempSchema</code>: A schema where temp tables can be created in Oracle.</li>
<li>
<code>cdmDatabaseSchema</code>: The name of the database schema that contains the OMOP CDM instance. On SQL Server, this will specifiy both the database and the schema, so for example ‘cdm_instance.dbo’.</li>
<li>
<code>cdmVersion</code>: Defines the OMOP CDM version used: currently supports “4” and “5”.</li>
<li>
<code>cohortTable</code>: Name of the table holding the cohort for which we want to construct covariates. This is a fully specified name, so either the name of a temp table (e.g. ‘#cohort_table’), or a permanent table including its database schema (e.g. ‘cdm_schema.dbo.cohort’).</li>
<li>
<code>cohortId</code>: The cohort definition ID of the cohort. If set to -1, use all entries in the cohort table.</li>
<li>
<code>cdmVersion</code>: The version of the Common Data Model.</li>
<li>
<code>rowIdField</code>: The name of the field in the cohort temp table that is to be used as the row_id field in the output table. This can be especially usefull if there is more than one period per person.</li>
<li>
<code>covariateSettings</code>: The object created in your covariate settings function.</li>
<li>
<code>aggregated</code>: Should covariates be constructed per-person, or aggregated across the cohort?</li>
</ul>
<p>The function can expect that a table exists with the name specified in the <code>cohortTable</code> argument. This table will identify the persons and the index dates for which we want to construct the covariates, and will have the following fields: <code>subject_id</code>, <code>cohort_start_date</code>, and <code>cohort_definition_id</code>. Because sometimes there can be more than one index date (i.e. <code>cohort_start_date</code>) per person, an additional field can be included with a unique identifier for each <code>subject_id</code> - <code>cohort_start_date</code> combination. The name of this field will be specified in the <code>rowIdField</code> argument</p>
</div>
<div id="function-outputs" class="section level2">
<h2 class="hasAnchor">
<a href="#function-outputs" class="anchor"></a>Function outputs</h2>
<p>The function must return an object of type <code>covariateData</code>, which is a list with the following members:</p>
<ul>
<li>
<code>covariates</code>: An <code>ffdf</code> object listing the covariates per row ID. This is done using a sparse representation; covariates with a value of 0 are omitted to save space. The covariates object must have three columns: <code>rowId</code>, <code>covariateId</code>, and <code>covariateValue</code>.</li>
<li>
<code>covariateRef</code>: An <code>ffdf</code> object describing the covariates that have been extracted. This should have the following columns: <code>covariateId</code>, <code>covariateName</code>, <code>analysisId</code>, <code>conceptId</code>.</li>
<li>
<code>analysisRef</code>: An <code>ffdf</code> object describing the analyses performed by the function. This should have the following columns: <code>analysisId</code>, <code>analysisName</code>, <code>domainIdsta</code>, <code>startDay</code>, <code>endDay</code>, <code>isBinary</code>, <code>missingMeansZero</code>.</li>
<li>
<code>metaData</code>: A list of objects with information on how the <code>covariateData</code> object was constructed.</li>
</ul>
</div>
<div id="example-function-1" class="section level2">
<h2 class="hasAnchor">
<a href="#example-function-1" class="anchor"></a>Example function</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>getDbLooCovariateData &lt;-<span class="st"> </span><span class="cf">function</span>(connection,</span>
<span id="cb2-2"><a href="#cb2-2"></a>                                  <span class="dt">oracleTempSchema =</span> <span class="ot">NULL</span>,</span>
<span id="cb2-3"><a href="#cb2-3"></a>                                  cdmDatabaseSchema,</span>
<span id="cb2-4"><a href="#cb2-4"></a>                                  <span class="dt">cohortTable =</span> <span class="st">"#cohort_person"</span>,</span>
<span id="cb2-5"><a href="#cb2-5"></a>                                  <span class="dt">cohortId =</span> <span class="dv">-1</span>,</span>
<span id="cb2-6"><a href="#cb2-6"></a>                                  <span class="dt">cdmVersion =</span> <span class="st">"5"</span>,</span>
<span id="cb2-7"><a href="#cb2-7"></a>                                  <span class="dt">rowIdField =</span> <span class="st">"subject_id"</span>,</span>
<span id="cb2-8"><a href="#cb2-8"></a>                                  covariateSettings,</span>
<span id="cb2-9"><a href="#cb2-9"></a>                                  <span class="dt">aggregated =</span> <span class="ot">FALSE</span>) {</span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="kw"><a href="https://rdrr.io/r/base/writeLines.html">writeLines</a></span>(<span class="st">"Constructing length of observation covariates"</span>)</span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="cf">if</span> (covariateSettings<span class="op">$</span>useLengthOfObs <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>) {</span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="ot">NULL</span>)</span>
<span id="cb2-13"><a href="#cb2-13"></a>  }</span>
<span id="cb2-14"><a href="#cb2-14"></a>  <span class="cf">if</span> (aggregated)</span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Aggregation not supported"</span>)</span>
<span id="cb2-16"><a href="#cb2-16"></a>  </span>
<span id="cb2-17"><a href="#cb2-17"></a>  <span class="co"># Some SQL to construct the covariate:</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>  sql &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"SELECT @row_id_field AS row_id, 1 AS covariate_id,"</span>,</span>
<span id="cb2-19"><a href="#cb2-19"></a>               <span class="st">"DATEDIFF(DAY, observation_period_start_date, cohort_start_date)"</span>,</span>
<span id="cb2-20"><a href="#cb2-20"></a>               <span class="st">"AS covariate_value"</span>,</span>
<span id="cb2-21"><a href="#cb2-21"></a>               <span class="st">"FROM @cohort_table c"</span>,</span>
<span id="cb2-22"><a href="#cb2-22"></a>               <span class="st">"INNER JOIN @cdm_database_schema.observation_period op"</span>,</span>
<span id="cb2-23"><a href="#cb2-23"></a>               <span class="st">"ON op.person_id = c.subject_id"</span>,</span>
<span id="cb2-24"><a href="#cb2-24"></a>               <span class="st">"WHERE cohort_start_date &gt;= observation_period_start_date"</span>,</span>
<span id="cb2-25"><a href="#cb2-25"></a>               <span class="st">"AND cohort_start_date &lt;= observation_period_end_date"</span>,</span>
<span id="cb2-26"><a href="#cb2-26"></a>               <span class="st">"{@cohort_id != -1} ? {AND cohort_definition_id = @cohort_id}"</span>)</span>
<span id="cb2-27"><a href="#cb2-27"></a>  sql &lt;-<span class="st"> </span>SqlRender<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/SqlRender/man/render.html">render</a></span>(sql,</span>
<span id="cb2-28"><a href="#cb2-28"></a>                              <span class="dt">cohort_table =</span> cohortTable,</span>
<span id="cb2-29"><a href="#cb2-29"></a>                              <span class="dt">cohort_id =</span> cohortId,</span>
<span id="cb2-30"><a href="#cb2-30"></a>                              <span class="dt">row_id_field =</span> rowIdField,</span>
<span id="cb2-31"><a href="#cb2-31"></a>                              <span class="dt">cdm_database_schema =</span> cdmDatabaseSchema)</span>
<span id="cb2-32"><a href="#cb2-32"></a>  sql &lt;-<span class="st"> </span>SqlRender<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/SqlRender/man/translate.html">translate</a></span>(sql, <span class="dt">targetDialect =</span> <span class="kw"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(connection, <span class="st">"dbms"</span>))</span>
<span id="cb2-33"><a href="#cb2-33"></a>  </span>
<span id="cb2-34"><a href="#cb2-34"></a>  <span class="co"># Retrieve the covariate:</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>  covariates &lt;-<span class="st"> </span>DatabaseConnector<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DatabaseConnector/man/querySql.ffdf.html">querySql.ffdf</a></span>(connection, sql)</span>
<span id="cb2-36"><a href="#cb2-36"></a>  </span>
<span id="cb2-37"><a href="#cb2-37"></a>  <span class="co"># Convert colum names to camelCase:</span></span>
<span id="cb2-38"><a href="#cb2-38"></a>  <span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(covariates) &lt;-<span class="st"> </span>SqlRender<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/SqlRender/man/snakeCaseToCamelCase.html">snakeCaseToCamelCase</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(covariates))</span>
<span id="cb2-39"><a href="#cb2-39"></a>  </span>
<span id="cb2-40"><a href="#cb2-40"></a>  <span class="co"># Construct covariate reference:</span></span>
<span id="cb2-41"><a href="#cb2-41"></a>  covariateRef &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">covariateId =</span> <span class="dv">1</span>,</span>
<span id="cb2-42"><a href="#cb2-42"></a>                             <span class="dt">covariateName =</span> <span class="st">"Length of observation"</span>,</span>
<span id="cb2-43"><a href="#cb2-43"></a>                             <span class="dt">analysisId =</span> <span class="dv">1</span>,</span>
<span id="cb2-44"><a href="#cb2-44"></a>                             <span class="dt">conceptId =</span> <span class="dv">0</span>)</span>
<span id="cb2-45"><a href="#cb2-45"></a>  covariateRef &lt;-<span class="st"> </span>ff<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/ff/man/as.ffdf.html">as.ffdf</a></span>(covariateRef)</span>
<span id="cb2-46"><a href="#cb2-46"></a>  </span>
<span id="cb2-47"><a href="#cb2-47"></a>  <span class="co"># Construct analysis reference:</span></span>
<span id="cb2-48"><a href="#cb2-48"></a>  analysisRef &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">analysisId =</span> <span class="dv">1</span>,</span>
<span id="cb2-49"><a href="#cb2-49"></a>                            <span class="dt">analysisName =</span> <span class="st">"Length of observation"</span>,</span>
<span id="cb2-50"><a href="#cb2-50"></a>                            <span class="dt">domainId =</span> <span class="st">"Demographics"</span>,</span>
<span id="cb2-51"><a href="#cb2-51"></a>                            <span class="dt">startDay =</span> <span class="dv">0</span>,</span>
<span id="cb2-52"><a href="#cb2-52"></a>                            <span class="dt">endDay =</span> <span class="dv">0</span>,</span>
<span id="cb2-53"><a href="#cb2-53"></a>                            <span class="dt">isBinary =</span> <span class="st">"N"</span>,</span>
<span id="cb2-54"><a href="#cb2-54"></a>                            <span class="dt">missingMeansZero =</span> <span class="st">"Y"</span>)</span>
<span id="cb2-55"><a href="#cb2-55"></a>  analysisRef &lt;-<span class="st"> </span>ff<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/ff/man/as.ffdf.html">as.ffdf</a></span>(analysisRef)</span>
<span id="cb2-56"><a href="#cb2-56"></a>  </span>
<span id="cb2-57"><a href="#cb2-57"></a>  <span class="co"># Construct analysis reference:</span></span>
<span id="cb2-58"><a href="#cb2-58"></a>  metaData &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">sql =</span> sql, <span class="dt">call =</span> <span class="kw"><a href="https://rdrr.io/r/base/match.call.html">match.call</a></span>())</span>
<span id="cb2-59"><a href="#cb2-59"></a>  result &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">covariates =</span> covariates, </span>
<span id="cb2-60"><a href="#cb2-60"></a>                 <span class="dt">covariateRef =</span> covariateRef, </span>
<span id="cb2-61"><a href="#cb2-61"></a>                 <span class="dt">analysisRef =</span> analysisRef,</span>
<span id="cb2-62"><a href="#cb2-62"></a>                 <span class="dt">metaData =</span> metaData)</span>
<span id="cb2-63"><a href="#cb2-63"></a>  <span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(result) &lt;-<span class="st"> "covariateData"</span></span>
<span id="cb2-64"><a href="#cb2-64"></a>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(result)</span>
<span id="cb2-65"><a href="#cb2-65"></a>}</span></code></pre></div>
<p>In this example function, we construct a single covariate called ‘Length of observation’, which is the number of days between the <code>observation_period_start_date</code> and the index date. We use parameterized SQL and the <code>SqlRender</code> package to generate the appropriate SQL statement for the database to which we are connected. Using the <code>DatabaseConnector</code> package, the result are immediately stored in an <code>ffdf</code> object. We also create the covariate reference and analysis reference objects, which have one row each, specifying our one covariate and one analysis. We then wrap up the <code>covariate</code>, <code>covariateRef</code>, and <code>analysisRef</code> objects in a single result object, together with some meta-data.</p>
</div>
</div>
<div id="using-the-custom-covariate-builder" class="section level1">
<h1 class="hasAnchor">
<a href="#using-the-custom-covariate-builder" class="anchor"></a>Using the custom covariate builder</h1>
<p>We can use our custom covariate builder in the <code>PatientLevelPrediction</code> package, as well other packages that depend on the <code>FeatureExtraction</code> package, such as the <code>CohortMethod</code> package. If we want to use only our custom defined covariate builder, we can simply replace the existing <code>covariateSettings</code> with our own, for example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>looCovSet &lt;-<span class="st"> </span><span class="kw">createLooCovariateSettings</span>(<span class="dt">useLengthOfObs =</span> <span class="ot">TRUE</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a>covariates &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getDbCovariateData.html">getDbCovariateData</a></span>(<span class="dt">connectionDetails =</span> connectionDetails,</span>
<span id="cb3-4"><a href="#cb3-4"></a>                                 <span class="dt">cdmDatabaseSchema =</span> cdmDatabaseSchema,</span>
<span id="cb3-5"><a href="#cb3-5"></a>                                 <span class="dt">cohortDatabaseSchema =</span> resultsDatabaseSchema,</span>
<span id="cb3-6"><a href="#cb3-6"></a>                                 <span class="dt">cohortTable =</span> <span class="st">"rehospitalization"</span>,</span>
<span id="cb3-7"><a href="#cb3-7"></a>                                 <span class="dt">cohortId =</span> <span class="dv">1</span>,</span>
<span id="cb3-8"><a href="#cb3-8"></a>                                 <span class="dt">covariateSettings =</span> looCovSet)</span></code></pre></div>
<p>In this case we will have only one covariate for our predictive model, the length of observation. In most cases, we will want our custom covariates in addition to the default covariates. We can do this by creating a list of covariate settings:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>covariateSettings &lt;-<span class="st"> </span><span class="kw"><a href="../reference/createCovariateSettings.html">createCovariateSettings</a></span>(<span class="dt">useDemographicsGender =</span> <span class="ot">TRUE</span>,</span>
<span id="cb4-2"><a href="#cb4-2"></a>                                             <span class="dt">useDemographicsAgeGroup =</span> <span class="ot">TRUE</span>,</span>
<span id="cb4-3"><a href="#cb4-3"></a>                                             <span class="dt">useDemographicsRace =</span> <span class="ot">TRUE</span>,</span>
<span id="cb4-4"><a href="#cb4-4"></a>                                             <span class="dt">useDemographicsEthnicity =</span> <span class="ot">TRUE</span>,</span>
<span id="cb4-5"><a href="#cb4-5"></a>                                             <span class="dt">useDemographicsIndexYear =</span> <span class="ot">TRUE</span>,</span>
<span id="cb4-6"><a href="#cb4-6"></a>                                             <span class="dt">useDemographicsIndexMonth =</span> <span class="ot">TRUE</span>)</span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a>looCovSet &lt;-<span class="st"> </span><span class="kw">createLooCovariateSettings</span>(<span class="dt">useLengthOfObs =</span> <span class="ot">TRUE</span>)</span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a>covariateSettingsList &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(covariateSettings, looCovSet)</span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a>covariates &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getDbCovariateData.html">getDbCovariateData</a></span>(<span class="dt">connectionDetails =</span> connectionDetails,</span>
<span id="cb4-13"><a href="#cb4-13"></a>                                 <span class="dt">cdmDatabaseSchema =</span> cdmDatabaseSchema,</span>
<span id="cb4-14"><a href="#cb4-14"></a>                                 <span class="dt">cohortDatabaseSchema =</span> resultsDatabaseSchema,</span>
<span id="cb4-15"><a href="#cb4-15"></a>                                 <span class="dt">cohortTable =</span> <span class="st">"rehospitalization"</span>,</span>
<span id="cb4-16"><a href="#cb4-16"></a>                                 <span class="dt">cohortId =</span> <span class="dv">1</span>,</span>
<span id="cb4-17"><a href="#cb4-17"></a>                                 <span class="dt">covariateSettings =</span> covariateSettingsList)</span></code></pre></div>
<p>In this example both demographic covariates and our length of observation covariate will be generated and can be used in our predictive model.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#overview">Overview</a></li>
      <li>
<a href="#covariate-settings-function">Covariate settings function</a><ul class="nav nav-pills nav-stacked">
<li><a href="#example-function">Example function</a></li>
      </ul>
</li>
      <li>
<a href="#covariate-construction-function">Covariate construction function</a><ul class="nav nav-pills nav-stacked">
<li><a href="#function-inputs">Function inputs</a></li>
      <li><a href="#function-outputs">Function outputs</a></li>
      <li><a href="#example-function-1">Example function</a></li>
      </ul>
</li>
      <li><a href="#using-the-custom-covariate-builder">Using the custom covariate builder</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Martijn Schuemie, Marc Suchard, Patrick Ryan, Jenna Reps.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9100.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
